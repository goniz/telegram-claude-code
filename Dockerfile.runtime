# Runtime Dockerfile for development session containers with rootless Docker-in-Docker
# This image provides a secure rootless environment with Claude Code and development tools

FROM docker:25.0-dind-rootless

# Build arguments for language versions with defaults
ARG RUST_VERSION=1.87.0
ARG GO_VERSION=1.23.4

# Switch to root for package installation
USER root

# Install essential development packages including build tools
RUN apk add --no-cache \
    bash \
    curl \
    git \
    nodejs \
    npm \
    python3 \
    py3-pip \
    github-cli \
    build-base \
    gcc \
    g++ \
    make \
    cmake \
    musl-dev \
    linux-headers

# Install Go from official source using build arg version
RUN wget -O go.tar.gz https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go.tar.gz && \
    rm go.tar.gz && \
    ln -s /usr/local/go/bin/go /usr/local/bin/go && \
    ln -s /usr/local/go/bin/gofmt /usr/local/bin/gofmt

# Install Rust using rustup (as non-root user later)
# First create a non-root user for rustup installation
RUN adduser -D -s /bin/bash -u 1000 developer

# Switch to developer user to install Rust
USER developer
WORKDIR /home/developer

# Install Rust via rustup using build arg version
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${RUST_VERSION} && \
    . ~/.cargo/env && \
    rustup component add clippy rustfmt

# Switch back to root for remaining installations
USER root

# Add Rust binaries to system PATH
ENV PATH="/home/developer/.cargo/bin:$PATH"

# Install Claude Code globally
RUN npm install -g @anthropic-ai/claude-code

# Install common Python packages
RUN pip3 install --break-system-packages \
    requests \
    virtualenv \
    pip-tools

# Create workspace directory and set permissions
RUN mkdir -p /workspace && chown developer:developer /workspace

# Set environment variables
ENV DISABLE_AUTOUPDATER=1
ENV DISABLE_ERROR_REPORTING=1
ENV DISABLE_TELEMETRY=1
ENV CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
ENV GOPATH=/home/developer/go
ENV GOROOT=/usr/local/go
ENV PATH="/usr/local/go/bin:/home/developer/.cargo/bin:$PATH"

# Set working directory
WORKDIR /workspace

# Switch back to rootless user
USER 1000:1000