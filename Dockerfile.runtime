# Runtime Dockerfile for development session containers with rootless Docker-in-Docker
# This image provides a secure rootless environment with Claude Code and development tools

FROM docker:25.0.3-dind-rootless

# Build arguments for language versions with defaults
ARG RUST_VERSION=1.87.0
ARG GO_VERSION=1.24.4

# Switch to root for package installation
USER root

# Install essential development packages including build tools
RUN apk update && apk add --no-cache \
    bash \
    curl \
    wget \
    git \
    nodejs \
    npm \
    python3 \
    py3-pip \
    github-cli \
    build-base \
    gcc \
    g++ \
    make \
    cmake \
    musl-dev \
    linux-headers \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Install common Python packages
RUN pip3 install --break-system-packages \
    requests \
    virtualenv \
    pip-tools

# Install Go from official source using build arg version
RUN wget -q -O go.tar.gz "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" && \
    tar -C /usr/local -xzf go.tar.gz && \
    rm go.tar.gz

# Create workspace directory and set permissions
RUN mkdir -p /workspace && chown 1000:1000 /workspace

# The rootless image already has a user with UID 1000, just use that existing user
# No need to create a new user - the base image provides a suitable user with UID 1000

# Switch to rootless user to install Rust
USER rootless
WORKDIR /home/rootless

# Install Rust via rustup using build arg version
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${RUST_VERSION} && \
    . ~/.cargo/env && \
    rustup component add clippy rustfmt

# Install Claude Code locally for the rootless user
RUN npm install @anthropic-ai/claude-code

# Set environment variables for development tools
ENV GOPATH=/home/rootless/go
ENV GOROOT=/usr/local/go
ENV PATH="/usr/local/go/bin:/home/rootless/.cargo/bin:/home/rootless/node_modules/.bin:$PATH"

# Claude Code configuration
ENV DISABLE_AUTOUPDATER=1
ENV DISABLE_ERROR_REPORTING=1
ENV DISABLE_TELEMETRY=1
ENV CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

# Set working directory
WORKDIR /workspace
